#define DX_TRACK_PANEL_HANDLES
(
   (dx_set_scoreboard_pos
      {{{coop_track_panel find scoreboard} find scoreboard.grp} set_local_pos $scoreboardpos_0 $scoreboardpos_1 $scoreboardpos_2}
   )
   (dx_set_star_display_pos
      {if {gamemode in_mode qp_coop}
         {unless {&& {! $star_displaypos_0} {! $star_displaypos_1} {! $star_displaypos_2}}
            {{{{coop_track_panel find scoreboard} find star_display} find stars.grp} set_local_pos $star_displaypos_0 $star_displaypos_1 $star_displaypos_2}
         }
      }
   )
   (dx_set_solo_box_pos
      {unless {&& {! $solo_boxpos_0} {! $solo_boxpos_1} {! $solo_boxpos_2}}
         {beatmatch foreach_active_player $player
            {unless {== {$player instrument} vocals}
               {{{{find_obj DX_GEMTRACKDIR} find player_feedback} find feedback.grp} set_local_pos $solo_boxpos_0 $solo_boxpos_1 $solo_boxpos_2}
            }
         }
      }
   )
   (dx_track_panel_exit ;this is really stupid but debug found out that the textures need to be put back to origin, deleted, and remade per enter
      {unless {$this get dx_is_nohud}
         {{coop_track_panel find fcframe.tex} iterate_refs $ref {$ref set diffuse_tex streak_meter_plate.tex}} ;apply the fc texture to the ring material
         {{coop_track_panel find multframe.tex} iterate_refs $ref {$ref set diffuse_tex streak_meter_plate.tex}} ;apply the fc texture to the ring material
         {{coop_track_panel find streak_meter_plate.tex} iterate_refs $ref {$ref set diffuse_tex streak_meter_plate.tex}} ;apply the fc texture to the ring material
         {{coop_track_panel find dx_star_base.tex} iterate_refs $ref {$ref set diffuse_tex score_star_frame.tex}} ;apply the fc texture to the ring material
         {{coop_track_panel find score_star_frame.tex} iterate_refs $ref {$ref set diffuse_tex score_star_frame.tex}} ;apply the fc texture to the ring material
         {{coop_track_panel find dx_star_gold_0.tex} iterate_refs $ref {$ref set diffuse_tex score_star_frame.tex}} ;apply the fc texture to the ring material
         {{coop_track_panel find dx_star_gold_1.tex} iterate_refs $ref {$ref set diffuse_tex score_star_frame.tex}} ;apply the fc texture to the ring material
         {{coop_track_panel find dx_star_gold_2.tex} iterate_refs $ref {$ref set diffuse_tex score_star_frame.tex}} ;apply the fc texture to the ring material
         {{coop_track_panel find dx_star_gold_3.tex} iterate_refs $ref {$ref set diffuse_tex score_star_frame.tex}} ;apply the fc texture to the ring material
         {{coop_track_panel find dx_star_gold_4.tex} iterate_refs $ref {$ref set diffuse_tex score_star_frame.tex}} ;apply the fc texture to the ring material
         {{coop_track_panel find dx_star_gold_5.tex} iterate_refs $ref {$ref set diffuse_tex score_star_frame.tex}} ;apply the fc texture to the ring material
         {{coop_track_panel find dx_star_gold_6.tex} iterate_refs $ref {$ref set diffuse_tex score_star_frame.tex}} ;apply the fc texture to the ring material
         {{coop_track_panel find dx_star_gold_7.tex} iterate_refs $ref {$ref set diffuse_tex score_star_frame.tex}} ;apply the fc texture to the ring material
         {{coop_track_panel find dx_star_gold_8.tex} iterate_refs $ref {$ref set diffuse_tex score_star_frame.tex}} ;apply the fc texture to the ring material
         {{coop_track_panel find dx_star_gold_9.tex} iterate_refs $ref {$ref set diffuse_tex score_star_frame.tex}} ;apply the fc texture to the ring material
         {{coop_track_panel find dx_star_gold_10.tex} iterate_refs $ref {$ref set diffuse_tex score_star_frame.tex}} ;apply the fc texture to the ring material
         #ifdef THIS_IS_DISABLED
         {if {exists fcframe.tex}
            {delete fcframe.tex}
         }
         {if {exists multframe.tex}
            {delete multframe.tex}
         }
         {if {exists dx_star_base.tex}
            {delete dx_star_base.tex}
         }
         {if {exists dx_star_gold_0.tex}
            {delete dx_star_gold_0.tex}
         }
         {if {exists dx_star_gold_1.tex}
            {delete dx_star_gold_1.tex}
         }
         {if {exists dx_star_gold_2.tex}
            {delete dx_star_gold_2.tex}
         }
         {if {exists dx_star_gold_3.tex}
            {delete dx_star_gold_3.tex}
         }
         {if {exists dx_star_gold_4.tex}
            {delete dx_star_gold_4.tex}
         }
         {if {exists dx_star_gold_5.tex}
            {delete dx_star_gold_5.tex}
         }
         {if {exists dx_star_gold_6.tex}
            {delete dx_star_gold_6.tex}
         }
         {if {exists dx_star_gold_7.tex}
            {delete dx_star_gold_7.tex}
         }
         {if {exists dx_star_gold_8.tex}
            {delete dx_star_gold_8.tex}
         }
         {if {exists dx_star_gold_9.tex}
            {delete dx_star_gold_9.tex}
         }
         {if {exists dx_star_gold_10.tex}
            {delete dx_star_gold_10.tex}
         }
         #endif
      }
   )
   (dx_force_remote_vox
      {if_else {session_mgr is_local}
         {beatmatch foreach_active_player $player
            {if {&& {== {$player instrument} vocals} {! {$this get dx_is_nohud}}}
               {{{find_obj {{get_track_panel} loaded_dir} vocals} get vox_configuration} set remote $dx_force_remote_vox}
               {{{{get_track_panel} find vocals} find tubes.grp} set_showing {! $dx_force_remote_vox}}
               {{{{get_track_panel} find vocals} find tubes_milo.grp} set_showing {! $dx_force_remote_vox}}
               {{{{get_track_panel} find vocals} find tube_range.grp} set_showing {! $dx_force_remote_vox}}
               {{{{get_track_panel} find vocals} find pitched_effect01.grp} set_showing {! $dx_force_remote_vox}}
               {{{{get_track_panel} find vocals} find pitched_effect02.grp} set_showing {! $dx_force_remote_vox}}
               {{{{get_track_panel} find vocals} find pitch_mid_marker.grp} set_showing {! $dx_force_remote_vox}}
               {{{{get_track_panel} find vocals} find phoneme0.grp} set_showing {! $dx_force_remote_vox}}
               {{{{get_track_panel} find vocals} find phoneme1.grp} set_showing {! $dx_force_remote_vox}}
               {{{{get_track_panel} find vocals} find phoneme2.grp} set_showing {! $dx_force_remote_vox}}
               {{{find_obj {{get_track_panel} loaded_dir} vocals} get vox_configuration} milo_apply}
            }
         }
         ; allows 2+ vocalists in an online session to view the pitch window
         {beatmatch foreach_active_player $player
            {if {&& {== {$player instrument} vocals} {{$player get_user} is_local} {! {$this get dx_is_nohud}}}
               {{{find_obj {{get_track_panel} loaded_dir} vocals} get vox_configuration} set remote FALSE}
               {{{{get_track_panel} find vocals} find tubes.grp} set_showing TRUE}
               {{{{get_track_panel} find vocals} find tubes_milo.grp} set_showing TRUE}
               {{{{get_track_panel} find vocals} find tube_range.grp} set_showing TRUE}
               {{{{get_track_panel} find vocals} find pitched_effect01.grp} set_showing TRUE}
               {{{{get_track_panel} find vocals} find pitched_effect02.grp} set_showing TRUE}
               {{{{get_track_panel} find vocals} find pitch_mid_marker.grp} set_showing TRUE}
               {{{{get_track_panel} find vocals} find phoneme0.grp} set_showing TRUE}
               {{{{get_track_panel} find vocals} find phoneme1.grp} set_showing TRUE}
               {{{{get_track_panel} find vocals} find phoneme2.grp} set_showing TRUE}
               {{{find_obj {{get_track_panel} loaded_dir} vocals} get vox_configuration} milo_apply}
            }
         }
      }
   )
   (dx_track_panel_extended_ui
      {beatmatch foreach_active_player $player ;handle adding the appropriate callbacks to each player
         {unless {== {$player instrument} vocals}
            {set_this {find_obj {{get_track_panel} loaded_dir} {sprint "track_" {{$player get_user} get_slot_num}} band_power_meter}}
            {tour_configure_challenge.anim set_frame 1}
            {set $curr_ms {beatmatch get_song_ms}} ;current time in ms
            {set $total_ms {{song_mgr get_meta_data {meta_performer song}} length_ms}} ;grab current song length in ms
            {set $percent_complete {/ $curr_ms $total_ms}}
            {tour_meter_wipe.anim set_frame $percent_complete}
            ;{tour_meter_wipe.anim animate (period 20) (dest 1)}
            {tour_show.trig trigger}
            ;{streak_meter_bg.mesh set_showing FALSE}
            ;{streak_meter_glass.mesh set_showing FALSE}
            {tour_flag_1.mesh set_showing FALSE}
            {tour_flag_2.mesh set_showing FALSE}
            {tour_flag_3.mesh set_showing FALSE}
            {tour_flag_rays.mesh set_showing FALSE}
            {tour_fx.mesh set_showing FALSE}
         }
      }
   )
   (dx_track_panel_enter
      {$this set dx_is_nohud {modifier_mgr is_modifier_active mod_nohud}}
      {if {|| {! {gamemode in_mode trainer} {! {gamemode in_mode campaign}}}} ;position objects based on user preference
         {$this dx_set_scoreboard_pos}
         {$this dx_set_solo_box_pos}
         {$this dx_set_star_display_pos}
         {$this dx_force_remote_vox}
         ; reset texts and hide them
         {dx_game_hud_label dx_hud_label_time_remaining $dx_hud_time_remaining_text_size $dx_hud_time_remaining_text_font $dx_hud_time_remaining_text_alignment $dx_hud_time_remaining_text_kerning $dx_hud_time_remaining_text_x $dx_hud_time_remaining_text_z $dx_hud_time_remaining_text_y $dx_hud_time_remaining_text_r $dx_hud_time_remaining_text_g $dx_hud_time_remaining_text_b TRUE}
         {dx_game_hud_label dx_hud_label_band_streak $dx_hud_band_streak_text_size $dx_hud_band_streak_text_font $dx_hud_band_streak_text_alignment $dx_hud_band_streak_text_kerning $dx_hud_band_streak_text_x $dx_hud_band_streak_text_z $dx_hud_band_streak_text_y $dx_hud_band_streak_text_r $dx_hud_band_streak_text_g $dx_hud_band_streak_text_b TRUE}
         {beatmatch foreach_active_player $player
            {unless {== {$player instrument} vocals}
               {dx_track_label dx_track_label_username $dx_highway_username_text_size $dx_highway_username_text_font $dx_highway_username_text_alignment $dx_highway_username_text_kerning $dx_highway_username_text_x $dx_highway_username_text_y $dx_highway_username_text_r $dx_highway_username_text_g $dx_highway_username_text_b TRUE}
               {dx_track_label_streak dx_track_label_streak $dx_highway_streak_text_size $dx_highway_streak_text_font $dx_highway_streak_text_alignment $dx_highway_streak_text_kerning $dx_highway_streak_text_r $dx_highway_streak_text_g $dx_highway_streak_text_b TRUE}
               {dx_track_label dx_track_label_overdrive $dx_highway_overdrive_text_size $dx_highway_overdrive_text_font $dx_highway_overdrive_text_alignment $dx_highway_overdrive_text_kerning $dx_highway_overdrive_text_x $dx_highway_overdrive_text_y $dx_highway_overdrive_text_r $dx_highway_overdrive_text_g $dx_highway_overdrive_text_b TRUE}
            }
         }
      }
      {dx_add_player_sinks} ;add in fc/streak tracking callbacks to players
      #ifndef HX_WII
      {dx_apply_remote_textures} ;sync highway textures with remote players
      {dx_apply_remote_track_speeds} ;sync track speeds with remote players
      #endif
      {$this track_texture_reset_handler} ;set up all custom textures
      {if {! {gamemode in_mode trainer}}
         {dx_track_bre_reset}
      }
      {dx_track_angle_var_reset} ;reset the track angle just to be safe
      {unless $dx_texloadonce {dx_default_texture_var_reset}} ;reset rb3 textures if no textures have been loaded yet
      {dx_reset_track_meshes} ;unhide track meshes just incase user quit last song mid-countdown
   )
   (dx_track_panel_on_extend
      {if {! {gamemode in_mode trainer}}
         {dx_track_streak_reset}
         {dx_bassgroove_reset}
         {dx_set_song_speed}
         {dx_toggle_fail_feedback}
         {beatmatch foreach_active_player $player
            {unless {== {$player instrument} vocals}
               {{{find_obj DX_GEMTRACKDIR} find player_feedback} set_showing TRUE}
               {if_else {modifier_mgr is_modifier_active mod_brutalmode}
                  {dx_brutal_mode {modifier_mgr is_modifier_active mod_brutalmode}} ;call it now to reset the values, even if bottom_y doesn't stick, the beat handler will set it once the first time it runs
                  {{find_obj DX_GEMTRACKDIR} set bottom_y -26}
               }
               {{{{find_obj DX_GEMTRACKDIR} find player_feedback} find points.lbl} #ifdef RB3DX set_token_fmt dx_points #else set_localized dx_points #endif}
            }
            {if {== {$player instrument} vocals}
               {{PLAYER_FEEDBACK_VOX find points.lbl} #ifdef RB3DX set_token_fmt dx_points #else set_localized dx_points #endif}
            }
         }
         {dx_track_configurer}
         {dx_track_fc_reset}
         {dx_show_track_username}
         {dx_dim_remote_players}
         {$this dx_track_panel_extended_ui}
         {if {! {modifier_mgr is_modifier_active mod_brutalmode}} ;brutal mode relies on crowd meter accuracy
            {if {== $dx_crowd_meter_state dx_disabled} {adjust_crowd_rating 1}} ;max out crowd meter when it's disabled for crowd audio
         }
         {dx_set_player_names $dx_diff_popups}
         {if $dx_auto_endurance
            {fake_win 5}
         }
      }
   )
)